# [秒杀系统](https://www.bilibili.com/video/BV1sf4y1L7KE)

## 技术点总结

### 前端

- Thymeleaf
	- 与html搭配实现动态页面（类似html+jsp）
	- 使用简单，只需创建Controller然后在resources/templates下创建对应的html即可
	- Thymeleaf页面跳转需要通过Controller来跳转，不能直接通过html，否则会出错
- Bootstrap
- Jqueryy

### 后端

- SpringBoot

- MybaitsPlus（基于Mybaits封装）

- Lombok（注解）

### 中间件

- RabbitMQ（异步 流量均分）

- Redis（缓存、数据库、消息中间件）

### 秒杀方案

- 功能开发
	- 商品列表
	- 商品详情
	- 秒杀
	- 订单详情
- 分布式Session
	- 用户登陆
	- 共享Session
- 压力测试
	- JMeter入门
	- 自定义变量
	- 正式压测
- 页面优化
	- 缓存
	- 静态化分离
- 服务优化
	- RabbitMQ消息队列
	- 接口优化
	- 分布式锁
- 接口安全
	- 隐藏秒杀地址
	- 验证码
	- 接口限流

## 如何设计一个秒杀系统

稳（高性能）、准（一致性）、快（高可用）

- 高性能。涉及大量并发读、写，支持高并发访问非常关键。

- 一致性。商品库存的实现方式同样关键。

- 高可用。难免会遇到考虑不到的情况，要保证系统的高可用性和准确性。

## 项目搭建

[字符集](https://mp.weixin.qq.com/s/X_OV4aUeJiFN9DIWMNpICA)

## 用户登陆

创建用户表

密码 md5两次加密 客户端做一次加密  服务端做一次加密

### 逆向工程

根据数据库创建响应类、接口 

### 登陆功能



### 自定义注解参数校验



### 异常处理



### 通过Cookie和Session实现登陆功能

 

### 分布式Session解决同步问题

Nginx负载均衡

#### Session复制

- 优点
	- 无需修改代码，只需修改Tomcat配置
- 缺点
	- Session同步传输占用内网带宽
	- 多台Tomcat同步性能指数级下降
	- Session占用内存，无法有效水平扩展

#### 前端存储

- 优点
	- 不占服务端内存
- 缺点
	- 存在安全风险
	- 数据大小收Cookie限制
	- 占用外网带宽

#### Session粘滞

- 优点
	- 无需修改代码
	- 服务端可水平扩展
- 缺点
	- 增加新机器，会重新Hash，导致重新登陆
	- 应用重启，会重新登陆

#### 后端集中存储

- 优点
	- 安全
	- 容易水平扩展
- 缺点
	- 增加复杂度
	- 需要修改代码



### Redis方案

Redis操作数据类型

set

get

mset

mget 

hset

hget

hmset

hmget

hgetall

hdel

del

list lpush rpush llen lrem lrange

set sadd smembers scard srem

sort set zadd zrange zcard zrem

设置失效时间 set code test ex 10 （ex 秒 px 毫秒） ttl code（pttl code 剩余毫秒） 剩余时间 get code 

set code test ex 10 [nx|xx] （可以用来设置锁）

#### Spring Session + Redis实现分布式session

添加依赖

```xml
 <!--spring data redis 依赖-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>

        <!--commons-pool2 对象池依赖-->
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-pool2</artifactId>
        </dependency>

        <!--spring session依赖-->
        <dependency>
            <groupId>org.springframework.session</groupId>
            <artifactId>spring-session-data-redis</artifactId>
        </dependency>
```

添加配置

```yml
spring:
  #  thymelaef 配置
  thymeleaf:
    cache: false

  #redis 配置
  redis:
  #服务器地址
    host: 192.168.152.130
    port: 6379
    #数据库
    database: 0
    #超时时间
    timeout: 10000ms
    lettuce:
      pool:
      #最大连接数
        max-active : 8
        #最大连接阻塞等待时间，默认-1
        max-wait: 10000ms
        #最大空闲连接，默认8
        max-idle: 200
        #最小空闲连接，默认0
        min-idle: 5
```

重新启动项目

### 优化登陆

Cookie+Redis

## 秒杀功能

### 商品列表页

用逆向工程生成所需的所有类

#### GoodsVo

### 商品详情页

### 秒杀功能实现

### 订单详情页



## 系统压测

### JMeter压测





### 配置不同的用户

准备一个配置文件config.txt 

## 页面缓存

商品列表轻易不更换  将其缓存到redis中 提升访问速度

## 对象缓存

将常用的对象缓存到redis中  例如用户User对象，但需注意，当用户信息更改时候需要删除redis中旧的缓存

## 商品详情页面静态化

商品详情变更较少，秒杀状态会变  将不变的静态化为html 剩余的用ajax调用 将原来的thymleaf动态页面转为html静态页面+ajax调用

## 秒杀静态化

针对库存超卖问题

在秒杀订单表中建立B树索引，使用user_id和goods_id作为索引字段防止重复抢购，并将订单存入redis加速

在减库存的时候使用事务 保证原子性

```java
@Transactional
```

## 消息队列

消息队列  + redis 减少访问数据库

安装Erlang 安装rabbitmq 

配置控制台

### Fanout模式

广播模式 将受到的消息发送给所有绑定的队列

### Direct模式

单播模式

route key

### Topic模式

组播(可以实现单播也可以实现广播)

实际使用较多

通配符 * #

### Headers模式

